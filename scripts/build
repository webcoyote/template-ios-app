#!/usr/bin/env bash
# Build the project
set -Eeuo pipefail
trap 'echo "${BASH_SOURCE[0]}: line $LINENO: $BASH_COMMAND: exitcode $?"' ERR
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR/.."
START_TIME=$(date +%s.%N)

DEVICE_ID=${DEVICE_ID:-$("$SCRIPT_DIR/get-device")}

ARGS=()
if [[ ${#DEVICE_ID} -eq 36 ]]; then
    # Simulator UUID
    ARGS+=("-destination" "platform=iOS Simulator,arch=arm64,id=$DEVICE_ID")
    ARGS+=("CODE_SIGNING_ALLOWED=NO")
else
    # Physical device UDID
    ARGS+=("-destination" "platform=iOS,id=$DEVICE_ID")
fi

if [[ -z "${NO_XCSIFT:-}" ]] && command -v xcsift &>/dev/null; then
    SIFT=(xcsift -WEq)
else
    ARGS+=("-quiet")
    SIFT=(cat)
fi

# Disable sandboxing when running inside sandvault to avoid nested sandbox-exec
if [[ -n "${SV_SESSION_ID:-}" ]]; then
    export SWIFTPM_DISABLE_SANDBOX=1
    export SWIFT_BUILD_USE_SANDBOX=0
    ARGS+=("-IDEPackageSupportDisableManifestSandbox=1")
    ARGS+=("-IDEPackageSupportDisablePackageSandbox=1")
    # shellcheck disable=SC2016 # Expressions don't expand in single quotes # that is intentional
    ARGS+=('OTHER_SWIFT_FLAGS=$(inherited) -disable-sandbox')
fi

PROJECT_FILE="$(fd "xcodeproj$" | head -1)"
xcodebuild \
    build \
    "${ARGS[@]}" \
    -project "$PROJECT_FILE" \
    -scheme App \
    -configuration Debug \
    -parallelizeTargets \
    -jobs "$(sysctl -n hw.ncpu)" \
    |& "${SIFT[@]}"

END_TIME=$(date +%s.%N)
ELAPSED_TIME=$(echo "$END_TIME - $START_TIME" | bc --mathlib | xargs printf "%.2f\n")
echo "âœ… Build completed in $ELAPSED_TIME seconds!"
